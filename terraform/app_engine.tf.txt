# Enable App Engine application (only created once per project)
resource "google_app_engine_application" "app" {
  project     = var.gcp_project
  location_id = var.gcp_region
}

# Storage bucket to hold the built React app artifact
resource "google_storage_bucket" "react_build_bucket" {
  name          = "${var.gcp_project}-react-build"
  location      = var.gcp_region
  force_destroy = true
}

# Upload the React build as a zip file (created by Jenkins)
resource "google_storage_bucket_object" "react_build_archive" {
  name   = "build.zip"
  bucket = google_storage_bucket.react_build_bucket.name
  source = "${path.module}/build.zip"
}

# Deploy your React build as a new App Engine version
resource "google_app_engine_standard_app_version" "react_app" {
  version_id = "v1-${formatdate('YYYYMMDDHHmmss', timestamp())}" # unique version per deploy
  service    = "default"
  runtime    = "nodejs20"

  deployment {
    zip {
      source_url = google_storage_bucket_object.react_build_archive.media_link
    }
  }

  env_variables = {
    NODE_ENV = "production"
  }
}
